/*
 * ODS
 *
 * This is a simple REST API to access Block Chain on Ethereum and handling Smart Contracts and Payment Channel as well.
 *
 * API version: 1.0.0
 * Contact: u.kuehn@tu-berlin.de
 * Generated by: Swagger Codegen (https://github.com/swagger-api/swagger-codegen.git)
 */

package swagger

import (
	"encoding/json"
	"restapidemo/model"

	"net/http"

	"github.com/rs/zerolog/log"
)

//Close does close the channel and do transaction
func Close(w http.ResponseWriter, r *http.Request) {
	w.Header().Set("Content-Type", "application/json; charset=UTF-8")
	alias := readValueFromPath(r, "alias")
	var existChannel model.OpenPaymentChannel
	var result model.Result
	var e model.ModelError

	errIn := json.NewDecoder(r.Body).Decode(&existChannel)
	result.Indata = existChannel
	result.Exception = e

	config, errCfg := setAndCheckAliasConfig(alias)
	_ = config

	if errCfg != nil {
		log.Info().Msg("error read config")
		w.WriteHeader(500)
		result.Success = false
		result.Exception.ShortMessage = "error reading config"
		e, _ := json.Marshal(result)
		w.Write(e)
		return
	}

	if errIn != nil {
		log.Info().Msg("no body available, abort")
		w.WriteHeader(500)
		result.Success = false
		result.Exception.ShortMessage = errIn.Error()
		result.Exception.Error = errIn
		e, _ := json.Marshal(result)
		w.Write(e)
		return
	}

	if sessionExists(alias) {
		sess := sessions[alias]
		sessions[alias] = nil
		sess.Backend.Close(existChannel.Target)
		sess.Listener.Close()
		sess.EthereumBackend.Close()
	} else {
		w.WriteHeader(404)
		return
	}

	b, errOut := json.Marshal(result)
	if errOut == nil {
		w.WriteHeader(http.StatusOK)
	} else {
		w.WriteHeader(500)
		log.Fatal().Msg(errOut.Error())
		return
	}

	//fmt.Println("header set")
	if errOut == nil {
		w.Write(b)
	}

	//fmt.Println("done")
}
